<html>
    <head>
        <title>OAuthSimple Test Document</title>
        <style type="text/css">
            #compute_signature {
                display: block;
            }
            label {
                width: 150px;
                float: left;
                text-align: right;
            }
            input[type=text] {
                width: 400px;
            }
            textarea {
                width: 400px;
                height: 200px;
            }
            input[type=radio]+label {
                float: none;
            }
        </style>
        <script src="OAuthSimple.js" ></script>
        <script src="Uri.js" ></script>
    </head>
    <body>
        <h1>OAuthSimple Test Document</h1>

        <p>This page uses the <a href="OAuthSimple.js">OAuthSimple
        JavaScript client</a> to compute OAuth 1 signatures. It doesn't
        send your secrets to any servers. It just uses them in your
        browser.</p>

        <form>
            Request<br/>
            <label>HTTP method</label><input name="http_method" type="text" /><br/>
            <label>URL</label><input name="url" type="text" /><br/>
            <label>Content-Type</label><input name="content_type" type="text" /><br/>
            <label>Request entity body</label><textarea name="body" type="text"></textarea><br/>
            Client credentials (consumer key and secret)<br/>
            <label>Token</label><input name="client_token" type="text" /><br/>
            <label>Secret</label><input name="client_secret" type="text" /><br/>
            Token credentials or temporary credentials (access token and secret, or request token and secret)<br/>
            <label>Token</label><input name="token_token" type="text" /><br/>
            <label>Secret</label><input name="token_secret" type="text" /><br/>
            OAuth parameters<br/>
            <label><a href="http://tools.ietf.org/html/rfc5849#section-2.1">Callback</a></label><input name="oauth_callback" type="text" /><br/>
            <label><a href="http://tools.ietf.org/html/rfc5849#section-2.3">Verifier</a></label><input name="oauth_verifier" type="text" /><br/>
            <label><a href="http://tools.ietf.org/html/rfc5849#section-3.3">Nonce</a></label><input name="nonce" type="text" /><br/>
            <label>Timestamp</label><input name="timestamp" type="text" /><br />
            <label>OAuth version</label><input name="oauth_version" type="text" value="1.0" /><br/>
            <a href="https://tools.ietf.org/html/rfc5849#section-3.5">Parameter transmission</a>
            <input name="parameter_transmission" type="radio" value="authorization_header" checked="checked" /><label>Authorization header</label>
            <input name="parameter_transmission" type="radio" value="uri_query" /><label>URI query</label>
            <input name="parameter_transmission" type="radio" value="request_entity_body" /><label>Request entity body</label><br/>
        </form>

        <input type="submit" id="compute_signature" value="Compute Signature" />

        <hr />

        Signature base string: <span id="signature_base_string"></span><br/>
        Signature: <span id="signature"></span><br/>
        Request<br/>
        Start line: <span id="request_start_line"></span><br/>
        Headers: <div id="request_headers"></div>
        Entity body: <div id="request_entity_body"></div>
        As curl: <div id="request_as_curl"></div>

        <script>

        // To get results in all their magnificent glory (rather than some error)
        // fill these out with your own magical Netflix API keys.
        // Don't have a magical Netflix API key yet?
        // http://developer.netflix.com
        //
            var compute = function() {

                var signatureBaseStringElt = document.getElementById("signature_base_string");
                var signatureElt = document.getElementById("signature");
                var requestStartLineElt = document.getElementById("request_start_line");
                var requestHeadersElt = document.getElementById("request_headers");
                var requestEntityBodyElt = document.getElementById("request_entity_body");
                var requestAsCurlElt = document.getElementById("request_as_curl");

                signatureBaseStringElt.innerText = "";
                signatureElt.innerText = "";
                requestStartLineElt.innerText = "";
                requestHeadersElt.innerText = "";
                requestEntityBodyElt.innerText = "";
                requestAsCurlElt.innerText = "";

                // Some easy defines
                var apiKey = document.getElementsByName("client_token")[0].value;
                var sharedSecret = document.getElementsByName("client_secret")[0].value;
                var accessToken = document.getElementsByName("token_token")[0].value;
                var tokenSecret = document.getElementsByName("token_secret")[0].value;
                var oauth_callback = document.getElementsByName("oauth_callback")[0].value;
                var oauth_verifier = document.getElementsByName("oauth_verifier")[0].value;
                var nonce = document.getElementsByName("nonce")[0].value;
                var timestamp = document.getElementsByName("timestamp")[0].value;
                var oauth_version = document.getElementsByName("oauth_version")[0].value;

                var httpMethod = document.getElementsByName("http_method")[0].value;
                var uri = new Uri(document.getElementsByName("url")[0].value);

                var contentType = document.getElementsByName("content_type")[0].value;
                var body = document.getElementsByName("body")[0].value;

                var queryPairsToQueryObject = function(pairs) {
                    var o = {};
                    for (i = 0; i < pairs.length; i++) {
                        decodedName = decodeURIComponent(pairs[i][0].replace(/\+/g, " "));
                        decodedValue = decodeURIComponent(pairs[i][1].replace(/\+/g, " "));
                        o[decodedName] = decodedValue;
                    }
                    return o;
                };

                var pathUri = uri.clone().setQuery("").setAnchor("");
                var path = pathUri.toString();
                var parameterPairs = uri.queryPairs;
                if (contentType === "application/x-www-form-urlencoded") {
                    var bodyPairs = new Uri("?" + body).queryPairs;
                    parameterPairs = parameterPairs.concat(bodyPairs);
                }

                var argumentsAsObject = queryPairsToQueryObject(parameterPairs);
                argumentsAsObject["oauth_nonce"] = nonce;
                argumentsAsObject["oauth_timestamp"] = timestamp;
                argumentsAsObject["oauth_version"] = oauth_version;
                if (oauth_callback !== "") {
                    argumentsAsObject["oauth_callback"] = oauth_callback;
                }
                if (oauth_verifier !== "") {
                    argumentsAsObject["oauth_verifier"] = oauth_verifier;
                }

                var body = document.getElementsByName("body")[0].value;

                var signedResult = (new OAuthSimple()).sign({
                    action:httpMethod,
                    path:path,
                    parameters:argumentsAsObject,
                    signatures:{
                      'consumer_key':apiKey, 'shared_secret': sharedSecret,
                      'access_token':accessToken,'access_secret':tokenSecret,
                    }}
                );

                try {
                    console.debug('result',signedResult);
                } catch (e) {};

                signatureBaseStringElt.innerText = signedResult.signature_base_string;
                signatureElt.innerText = signedResult.signature;
                var requestUri = uri.clone();
                var startLineUri = uri.clone();
                var parameterTransmissionElts = document.getElementsByName("parameter_transmission");
                var parameterTransmission = "";
                for (i = 0; i < parameterTransmissionElts.length; i++) {
                    if (parameterTransmissionElts[i].checked) {
                        var parameterTransmission = parameterTransmissionElts[i].value;
                    }
                }

                var authorizationHeader = "";
                var curlHeaderArgs = ""
                if (parameterTransmission == "authorization_header") {
                   authorizationHeader = "Authorization: " + signedResult.header;
                   curlHeaderArgs = " -H " + authorizationHeader;
                   requestHeadersElt.innerText = "Authorization: " + signedResult.header;
                } else if (parameterTransmission === "uri_query") {
                    for (var name in signedResult.parameters) {
                        if (name.match(/^oauth_/)) {
                            requestUri.addQueryParam(name, signedResult.parameters[name]);
                        }
                    }
                    startLineUri = requestUri.clone().setProtocol("").setUserInfo("").setHost("").setPort("").setAnchor("");
                } else if (parameterTransmission === "request_entity_body") {
                    for (var name in signedResult.parameters) {
                        if (name.match(/^oauth_/)) {
                            body += "&" + encodeURIComponent(name) + "=" + encodeURIComponent(signedResult.parameters[name]);
                        }
                    }
                }
                requestStartLineElt.innerText = httpMethod + " " + startLineUri.toString();
                requestEntityBodyElt.innerText = body;


                if (contentType !== "") {
                    curlHeaderArgs +=  " -H 'Content-Type: " + contentType + "'";
                }
 
                var curlBodyArgs = "";
                if (body !== "") {
                    curlBodyArgs = " --data-binary '" + body + "'";
                }
                requestAsCurlElt.innerText = "curl -X " + httpMethod + " " +
                    requestUri + curlHeaderArgs + curlBodyArgs;
            };

            computeElt = document.getElementById("compute_signature");
            computeElt.onclick = compute;

        </script>
    </body>
</html>
